<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Judicial File Backup System</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h3>ğŸ›ï¸ Judiciary System</h3>
                <p>File Backup & Management</p>
            </div>
            <ul class="sidebar-nav">
                <li class="nav-item active"><a href="dashboard.html"><i>ğŸ“Š</i> Dashboard</a></li>
                <li class="nav-item"><a href="cases.html"><i>ğŸ“</i> Case Management</a></li>
                <li class="nav-item"><a href="upload.html"><i>ğŸ“¤</i> File Upload</a></li>
                <li class="nav-item"><a href="search.html"><i>ğŸ”</i> Search Files</a></li>
                <li class="nav-item"><a href="backup.html"><i>ğŸ’¾</i> Backup Management</a></li>
                <li class="nav-item"><a href="users.html"><i>ğŸ‘¥</i> User Management</a></li>
            </ul>
            <div class="sidebar-footer p-3">
                <button class="btn btn-outline btn-block" onclick="logout()">ğŸšª Logout</button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <div>
                    <h2>Dashboard Overview</h2>
                    <p class="text-light" id="welcome-text">Welcome back, --</p>
                </div>
                <div class="user-menu">
                    <span id="user-name">--</span>
                    <div class="badge badge-success" id="user-role">--</div>
                </div>
            </header>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="total-cases">--</span>
                    <span class="stat-label">Total Cases</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="active-cases">--</span>
                    <span class="stat-label">Active Cases</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="files-stored">--</span>
                    <span class="stat-label">Files Stored</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="uptime">--</span>
                    <span class="stat-label">System Uptime</span>
                </div>
            </div>

            <!-- Dashboard Widgets -->
            <div class="dashboard-widgets">
                <div class="widget">
                    <div class="widget-header">
                        <h3>Recent Cases</h3>
                        <a href="cases.html" class="btn btn-sm btn-outline">View All</a>
                    </div>
                    <div class="widget-body">
                        <div class="table-container">
                            <table class="table" id="recent-cases-table">
                                <thead>
                                    <tr>
                                        <th>Case Number</th>
                                        <th>Title</th>
                                        <th>Status</th>
                                        <th>Last Activity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows populated via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="widget">
                    <div class="widget-header">
                        <h3>Backup Status</h3>
                        <button class="btn btn-sm btn-primary" onclick="startBackup()">Run Backup</button>
                    </div>
                    <div class="widget-body">
                        <div class="mb-3">
                            <strong>Last Backup:</strong> Today, 02:00 AM
                        </div>
                        <div class="mb-3">
                            <strong>Next Backup:</strong> Tomorrow, 02:00 AM
                        </div>
                        <div class="mb-3">
                            <strong>Storage Used:</strong> 
                            <div style="background: #e2e8f0; border-radius: 4px; height: 8px; margin-top: 4px;">
                                <div id="storage-bar" style="background: var(--success-color); width: 65%; height: 100%; border-radius: 4px;"></div>
                            </div>
                            <small id="storage-text">24.5GB of 50GB used</small>
                        </div>
                    </div>
                </div>

                <div class="widget">
                    <div class="widget-header">
                        <h3>System Alerts</h3>
                    </div>
                    <div class="widget-body">
                        <div class="alert" style="background: #fed7d7; color: #742a2a; padding: var(--spacing-md); border-radius: var(--border-radius); margin-bottom: var(--spacing-md);">
                            <strong>âš ï¸ Warning:</strong> Backup storage at 65% capacity
                        </div>
                        <div class="alert" style="background: #bee3f8; color: #1a365d; padding: var(--spacing-md); border-radius: var(--border-radius);">
                            <strong>â„¹ï¸ Info:</strong> System maintenance scheduled for Sunday
                        </div>
                    </div>
                </div>

                <div class="widget">
                    <div class="widget-header">
                        <h3>Quick Actions</h3>
                    </div>
                    <div class="widget-body">
                        <div class="d-flex flex-column gap-2">
                            <a href="upload.html" class="btn btn-outline">ğŸ“¤ Upload New Files</a>
                            <a href="cases.html" class="btn btn-outline">ğŸ“ Manage Cases</a>
                            <a href="search.html" class="btn btn-outline">ğŸ” Search Documents</a>
                            <a href="backup.html" class="btn btn-outline">ğŸ’¾ Backup Settings</a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('authToken'); // remove JWT
                window.location.href = 'index.html';   // redirect to login
            }
        }

        // Capitalize first letter
        function capitalizeFirstLetter(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Load logged-in user info
        async function loadCurrentUser() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) throw new Error('No auth token');

                const res = await fetch('http://localhost:5000/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!res.ok) throw new Error('Failed to fetch user');

                const user = await res.json();
                document.getElementById('welcome-text').textContent = `Welcome back, ${user.full_name}`;
                document.getElementById('user-name').textContent = user.full_name;
                document.getElementById('user-role').textContent = capitalizeFirstLetter(user.role);

            } catch (err) {
                console.error(err);
                alert('Session expired. Please log in again.');
                logout();
            }
        }

        // Load recent cases for dashboard
        async function loadRecentCases() {
            try {
                const token = localStorage.getItem('authToken');
                const res = await fetch('http://localhost:5000/api/cases?per_page=5', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!res.ok) throw new Error('Failed to fetch cases');

                const cases = await res.json();
                const tbody = document.querySelector('#recent-cases-table tbody');
                tbody.innerHTML = ''; // clear existing rows

                cases.forEach(c => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${c.case_number}</td>
                        <td>${c.title}</td>
                        <td><span class="badge ${c.status === 'Active' ? 'badge-success' : 'badge-warning'}">${c.status}</span></td>
                        <td>${c.last_activity}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error('Error loading cases:', err);
            }
        }

        // Dummy backup function
        function startBackup() {
            alert('Backup started!');
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentUser();
            loadRecentCases();
        });
    </script>
</body>
</html>
