<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Search - Kenya Judiciary Digital Archives</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Merriweather:wght@300;400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .search-header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--dark-navy) 100%);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-lg);
        }
        
        .search-box {
            background: white;
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .search-advanced {
            background: white;
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-md);
            box-shadow: var(--shadow-sm);
        }
        
        .search-results {
            margin-top: var(--spacing-lg);
        }
        
        .result-card {
            background: white;
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            border-left: 4px solid var(--gold);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        
        .result-title {
            font-family: var(--font-heading);
            font-weight: 600;
            color: var(--navy);
            font-size: 1.1rem;
        }
        
        .result-snippet {
            color: var(--slate);
            margin: var(--spacing-sm) 0;
            line-height: 1.6;
        }
        
        .result-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            color: var(--slate);
            margin-top: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .result-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .search-filters {
            background: white;
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .filter-section {
            margin-bottom: var(--spacing-lg);
        }
        
        .filter-title {
            font-weight: 600;
            color: var(--navy);
            margin-bottom: var(--spacing-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-tips {
            background: var(--light-gold);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }
        
        .highlight {
            background: var(--gold);
            color: var(--navy);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .saved-search {
            background: var(--light-gray);
            border-radius: var(--border-radius);
            padding: var(--spacing-sm);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .saved-search:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        code {
            background: var(--navy);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body data-requires-auth="true">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h3>‚öñÔ∏è Kenya Judiciary</h3>
                <p>Digital Archives System</p>
            </div>
            <ul class="sidebar-nav">
                <li class="nav-item"><a href="dashboard.html"><i>üìä</i> Judicial Dashboard</a></li>
                <li class="nav-item"><a href="cases.html"><i>üìÅ</i> Case Registry</a></li>
                <li class="nav-item"><a href="upload.html"><i>üì§</i> File Upload</a></li>
                <li class="nav-item active"><a href="search.html"><i>üîç</i> Legal Search</a></li>
                <li class="nav-item"><a href="backup.html"><i>üíæ</i> System Backups</a></li>
                <li class="nav-item"><a href="users.html"><i>üë•</i> User Registry</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="search-header">
                <h1 style="color: white;">Legal Document Search</h1>
                <p style="color: rgba(255, 255, 255, 0.9);">
                    Search across all judicial documents, case files, and legal records
                </p>
            </header>

            <!-- Search Interface -->
            <div class="search-box">
                <form id="searchForm">
                    <div class="form-group">
                        <div style="display: flex; gap: var(--spacing-sm);">
                            <input type="search" 
                                   class="form-control" 
                                   id="searchQuery"
                                   placeholder="Enter case number, document title, legal terms, or content keywords..."
                                   style="flex: 1; font-size: 1.1rem; padding: 1rem;">
                            <button type="submit" class="btn btn-primary" id="searchBtn">
                                <span class="spinner" id="searchSpinner" style="display: none; margin-right: 8px;"></span>
                                <i>üîç</i> Search
                            </button>
                            <button type="button" class="btn btn-outline" onclick="toggleAdvanced()" id="toggleAdvanced">
                                <i>‚öôÔ∏è</i> Advanced
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Search Options -->
                    <div class="search-advanced" id="advancedOptions" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg);">
                            <div class="filter-section">
                                <div class="filter-title">Document Type</div>
                                <div style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="docType" value="ruling" checked> Court Rulings
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="docType" value="evidence" checked> Evidence Documents
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="docType" value="statement"> Witness Statements
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="docType" value="affidavit"> Affidavits
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="docType" value="pleading"> Pleadings
                                    </label>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-title">Case Information</div>
                                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                                    <div>
                                        <label class="form-label">Case Number</label>
                                        <input type="text" class="form-control" name="caseNumber" placeholder="e.g., CR-2024-001">
                                    </div>
                                    <div>
                                        <label class="form-label">Presiding Judge</label>
                                        <select class="form-control form-select" name="judge">
                                            <option value="">Any Judge</option>
                                            <option>Justice Katanu</option>
                                            <option>Justice Mwangi</option>
                                            <option>Justice Omondi</option>
                                            <option>Justice Wambua</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-title">Date Range</div>
                                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                                    <div>
                                        <label class="form-label">From Date</label>
                                        <input type="date" class="form-control" name="dateFrom">
                                    </div>
                                    <div>
                                        <label class="form-label">To Date</label>
                                        <input type="date" class="form-control" name="dateTo">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-title">Search Options</div>
                                <div style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="searchOption" value="ocr" checked> Include OCR Text
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="searchOption" value="metadata" checked> Include Metadata
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="searchOption" value="exact"> Exact Phrase Match
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="searchOption" value="fuzzy"> Fuzzy Search
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: var(--spacing-md); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <button type="button" class="btn btn-outline" onclick="saveSearch()">
                                    <i>üíæ</i> Save Search
                                </button>
                                <button type="button" class="btn btn-outline" onclick="loadSavedSearch()">
                                    <i>üìÇ</i> Load Saved
                                </button>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="performAdvancedSearch()">
                                <i>üîç</i> Advanced Search
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Search Results -->
            <div class="search-results" id="searchResults">
                <!-- Results will be loaded here -->
            </div>

            <!-- Search Tips -->
            <div class="search-tips">
                <h3 style="color: var(--navy); margin-bottom: var(--spacing-sm);">Search Tips</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-lg);">
                    <div>
                        <h4 style="color: var(--navy); font-size: 1rem; margin-bottom: 0.5rem;">Quick Search Examples</h4>
                        <ul style="color: var(--slate); line-height: 1.8; font-size: 0.9rem;">
                            <li><code>"land dispute" AND Nakuru</code> - Exact phrase with location</li>
                            <li><code>fraud OR embezzlement</code> - Either term</li>
                            <li><code>CR-2024-001</code> - Specific case number</li>
                            <li><code>Justice Katanu AND criminal</code> - Judge and case type</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 style="color: var(--navy); font-size: 1rem; margin-bottom: 0.5rem;">Legal Operators</h4>
                        <ul style="color: var(--slate); line-height: 1.8; font-size: 0.9rem;">
                            <li><strong>AND</strong> - Both terms must appear</li>
                            <li><strong>OR</strong> - Either term can appear</li>
                            <li><strong>NOT</strong> - Exclude term from results</li>
                            <li><strong>" "</strong> - Exact phrase match</li>
                            <li><strong>*</strong> - Wildcard (e.g., <code>judg*</code> finds judge, judgment, etc.)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Saved Searches -->
            <div class="card" style="margin-top: var(--spacing-lg);">
                <div class="card-header">
                    <h3>Saved Searches</h3>
                </div>
                <div class="card-body">
                    <div id="savedSearches">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-sm);">
                            <div class="saved-search" onclick="loadSearch('recent_cases')" style="cursor: pointer;">
                                <div style="font-weight: 600; color: var(--navy);">Recent Criminal Cases</div>
                                <div style="font-size: 0.9rem; color: var(--slate);">case_type:criminal AND date:2024</div>
                            </div>
                            <div class="saved-search" onclick="loadSearch('land_disputes')" style="cursor: pointer;">
                                <div style="font-weight: 600; color: var(--navy);">Land Disputes 2024</div>
                                <div style="font-size: 0.9rem; color: var(--slate);">"land dispute" AND court:Nakuru</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        // ============ GLOBAL VARIABLES & CONSTANTS ============
        const API_ENDPOINTS = {
            search: '/api/search',
            document: (id) => `/api/documents/${id}`
        };

        let currentSearchResults = [];
        let isAdvancedVisible = false;

        // ============ HELPER FUNCTIONS ============
        function requireAuth() {
            // Check if user is authenticated
            const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
            if (!token) {
                showNotification('Please login to access search', 'error');
                return false;
            }
            return true;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
        }

        // ============ SEARCH FUNCTIONALITY ============

        async function performSearch(event) {
            if (event) event.preventDefault();
            
            if (!requireAuth()) return;
            
            const query = document.getElementById('searchQuery').value.trim();
            const searchBtn = document.getElementById('searchBtn');
            const spinner = document.getElementById('searchSpinner');
            
            if (!query) {
                showNotification('Please enter search terms', 'error');
                return;
            }
            
            // Show loading state
            searchBtn.disabled = true;
            spinner.style.display = 'inline-block';
            
            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Get mock results
                const results = getMockResults(query);
                currentSearchResults = results;
                displaySearchResults(results);
                
                showNotification(`Found ${results.length} documents`, 'success');
                
            } catch (error) {
                console.error('Search error:', error);
                showNotification('Search failed. Please try again.', 'error');
                // Fallback to mock data for demonstration
                displayMockResults();
            } finally {
                searchBtn.disabled = false;
                spinner.style.display = 'none';
            }
        }

        function getMockResults(query) {
            const mockResults = [
                {
                    id: 1,
                    title: 'Court Ruling on Criminal Case CR-2024-001',
                    filename: 'court_ruling_cr_2024_001.pdf',
                    case_number: 'CR-2024-001',
                    judge: 'Justice Katanu',
                    type: 'Court Ruling',
                    date: '2024-10-15',
                    size: '2.1 MB',
                    pages: '24',
                    ocr_processed: true,
                    snippet: 'The court finds the evidence presented compelling and rules in favor of the prosecution in the matter of financial fraud allegations. The defendant is found guilty on all counts.',
                    relevance: 0.95
                },
                {
                    id: 2,
                    title: 'Witness Statement - John Smith',
                    filename: 'witness_statement_john_smith.pdf',
                    case_number: 'CR-2024-001',
                    judge: 'Justice Katanu',
                    type: 'Witness Statement',
                    date: '2024-10-14',
                    size: '1.8 MB',
                    pages: '8',
                    ocr_processed: true,
                    snippet: 'I witnessed the incident on October 1st and can confirm the events as described in the police report regarding the land dispute. The boundary markings were clearly visible.',
                    relevance: 0.87
                },
                {
                    id: 3,
                    title: 'Photographic Evidence - Scene Documentation',
                    filename: 'evidence_photo_1.jpg',
                    case_number: 'CR-2024-001',
                    judge: 'Justice Katanu',
                    type: 'Evidence',
                    date: '2024-10-13',
                    size: '4.2 MB',
                    pages: '1',
                    ocr_processed: false,
                    snippet: 'Photographic evidence showing the scene of the incident with clear markings of the disputed property boundaries. The image was taken from the southwest corner.',
                    relevance: 0.76
                },
                {
                    id: 4,
                    title: 'Affidavit of Support - Jane Doe',
                    filename: 'affidavit_jane_doe.pdf',
                    case_number: 'CV-2024-012',
                    judge: 'Justice Mwangi',
                    type: 'Affidavit',
                    date: '2024-10-12',
                    size: '1.2 MB',
                    pages: '4',
                    ocr_processed: true,
                    snippet: 'I, Jane Doe, do solemnly swear that the following statement is true to the best of my knowledge regarding the property dispute in Nakuru County.',
                    relevance: 0.68
                },
                {
                    id: 5,
                    title: 'Pleading - Motion to Dismiss',
                    filename: 'motion_to_dismiss.pdf',
                    case_number: 'CR-2024-002',
                    judge: 'Justice Omondi',
                    type: 'Pleading',
                    date: '2024-10-11',
                    size: '2.5 MB',
                    pages: '12',
                    ocr_processed: true,
                    snippet: 'The defendant moves this honorable court to dismiss the charges for lack of evidence and improper procedure in the collection of alleged fraudulent documents.',
                    relevance: 0.62
                }
            ];

            // Filter based on query
            const lowerQuery = query.toLowerCase();
            return mockResults.filter(result => 
                result.title.toLowerCase().includes(lowerQuery) ||
                result.snippet.toLowerCase().includes(lowerQuery) ||
                result.case_number.toLowerCase().includes(lowerQuery) ||
                result.judge.toLowerCase().includes(lowerQuery)
            );
        }

        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (!results || results.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--slate);">
                        <i style="font-size: 3rem; opacity: 0.5; margin-bottom: 1rem;">üîç</i>
                        <h3>No Results Found</h3>
                        <p>Try different search terms or adjust your filters.</p>
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                    <h3>Search Results (${results.length} documents found)</h3>
                    <div>
                        <button class="btn btn-outline btn-sm" onclick="exportResults()">
                            <i>üì•</i> Export Results
                        </button>
                    </div>
                </div>
                ${results.map((result, index) => createResultCard(result, index)).join('')}
            `;
        }

        function createResultCard(result, index) {
            return `
                <div class="result-card" id="result-${index}">
                    <div class="result-header">
                        <div>
                            <div class="result-title">
                                <a href="javascript:void(0)" onclick="viewDocument('${result.id}')" style="color: var(--navy); text-decoration: none;">
                                    ${escapeHtml(result.title || result.filename)}
                                </a>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--slate); margin-top: 0.25rem;">
                                ${escapeHtml(result.case_number || '')}
                                ${result.case_number && result.judge ? ' ‚Ä¢ ' : ''}
                                ${escapeHtml(result.judge || '')}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="badge badge-${result.type === 'Court Ruling' ? 'info' : result.type === 'Evidence' ? 'warning' : 'success'}">
                                ${escapeHtml(result.type || 'Document')}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--slate); margin-top: 0.25rem;">
                                ${escapeHtml(result.date || '')}
                            </div>
                        </div>
                    </div>
                    
                    ${result.snippet ? `
                    <div class="result-snippet">
                        ...${highlightSearchTerms(result.snippet)}...
                    </div>
                    ` : ''}
                    
                    <div class="result-meta">
                        <div><strong>File:</strong> ${escapeHtml(result.filename)}</div>
                        <div><strong>Size:</strong> ${escapeHtml(result.size || 'N/A')}</div>
                        <div><strong>Pages:</strong> ${escapeHtml(result.pages || 'N/A')}</div>
                        <div><strong>OCR:</strong> ${result.ocr_processed ? 'Yes' : 'No'}</div>
                    </div>
                    
                    <div class="result-actions">
                        <button class="btn btn-sm btn-outline" onclick="viewDocument('${result.id}')">
                            <i>üëÅÔ∏è</i> View Document
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="downloadDocument('${result.id}')">
                            <i>üì•</i> Download
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="showDocumentInfo('${result.id}')">
                            <i>‚ÑπÔ∏è</i> Details
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="addToCase('${result.id}')">
                            <i>üìÅ</i> Add to Case
                        </button>
                        <div style="margin-left: auto;">
                            <span style="font-size: 0.8rem; color: var(--gold); font-weight: 600;">
                                ${result.relevance ? `${Math.round(result.relevance * 100)}% match` : ''}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        function highlightSearchTerms(text) {
            const query = document.getElementById('searchQuery').value.toLowerCase();
            if (!query) return escapeHtml(text);
            
            let highlighted = escapeHtml(text);
            
            // Split query into words and highlight each
            const words = query.split(' ').filter(word => word.length > 2);
            words.forEach(word => {
                const regex = new RegExp(`(${word})`, 'gi');
                highlighted = highlighted.replace(regex, '<span class="highlight">$1</span>');
            });
            
            return highlighted;
        }

        function displayMockResults() {
            const results = getMockResults('case');
            currentSearchResults = results;
            displaySearchResults(results);
        }

        // ============ BUTTON FUNCTIONS ============

        function toggleAdvanced() {
            const advanced = document.getElementById('advancedOptions');
            const toggleBtn = document.getElementById('toggleAdvanced');
            
            if (advanced.style.display === 'none') {
                advanced.style.display = 'block';
                toggleBtn.innerHTML = '<i>‚¨ÜÔ∏è</i> Simple';
                toggleBtn.classList.add('btn-primary');
                toggleBtn.classList.remove('btn-outline');
                isAdvancedVisible = true;
            } else {
                advanced.style.display = 'none';
                toggleBtn.innerHTML = '<i>‚öôÔ∏è</i> Advanced';
                toggleBtn.classList.remove('btn-primary');
                toggleBtn.classList.add('btn-outline');
                isAdvancedVisible = false;
            }
        }

        function performAdvancedSearch() {
            const form = document.getElementById('searchForm');
            const formData = new FormData(form);
            const params = new URLSearchParams();
            
            // Collect all form data
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }
            
            // Show what would be sent in a real app
            console.log('Advanced search params:', params.toString());
            
            // Perform search with advanced filters
            performSearch();
        }

        function saveSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                showNotification('Please enter a search query first', 'error');
                return;
            }
            
            const name = prompt('Name for this saved search:');
            if (name) {
                // Save to localStorage
                const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
                savedSearches.push({
                    name: name,
                    query: query,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('savedSearches', JSON.stringify(savedSearches));
                
                showNotification(`Search saved as "${name}"`, 'success');
                updateSavedSearchesDisplay();
            }
        }

        function loadSavedSearch() {
            const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
            if (savedSearches.length === 0) {
                showNotification('No saved searches found', 'info');
                return;
            }
            
            // Create list of saved searches
            let options = '';
            savedSearches.forEach((search, index) => {
                options += `<option value="${index}">${search.name} - "${search.query}"</option>`;
            });
            
            const selectHtml = `
                <div style="padding: 1rem;">
                    <label class="form-label">Select saved search:</label>
                    <select id="savedSearchSelect" class="form-control" style="width: 100%; margin-bottom: 1rem;">
                        ${options}
                    </select>
                </div>
            `;
            
            // Create custom modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Load Saved Search</h3>
                        <button class="btn btn-sm btn-outline" onclick="this.closest('.modal').remove()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        ${selectHtml}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="loadSelectedSearch()">Load Search</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function loadSelectedSearch() {
            const select = document.getElementById('savedSearchSelect');
            const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
            const index = parseInt(select.value);
            
            if (index >= 0 && index < savedSearches.length) {
                document.getElementById('searchQuery').value = savedSearches[index].query;
                showNotification(`Loaded search: ${savedSearches[index].name}`, 'success');
                
                // Close modal
                document.querySelector('.modal.active').remove();
            }
        }

        function loadSearch(name) {
            // Mock function for loading predefined searches
            let query = '';
            let searchName = '';
            
            switch(name) {
                case 'recent_cases':
                    query = 'case_type:criminal AND date:2024';
                    searchName = 'Recent Criminal Cases';
                    break;
                case 'land_disputes':
                    query = '"land dispute" AND court:Nakuru';
                    searchName = 'Land Disputes 2024';
                    break;
            }
            
            document.getElementById('searchQuery').value = query;
            showNotification(`Loaded search: ${searchName}`, 'success');
            performSearch();
        }

        function updateSavedSearchesDisplay() {
            const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
            const container = document.getElementById('savedSearches');
            
            if (savedSearches.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: var(--slate);">
                        No saved searches yet. Save a search to see it here.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-sm);">
                    ${savedSearches.map((search, index) => `
                        <div class="saved-search" onclick="loadSavedSearchItem(${index})" style="cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="font-weight: 600; color: var(--navy);">${escapeHtml(search.name)}</div>
                                    <div style="font-size: 0.9rem; color: var(--slate);">${escapeHtml(search.query)}</div>
                                </div>
                                <button class="btn btn-sm btn-outline" onclick="deleteSavedSearch(event, ${index})" style="margin-left: 0.5rem;">
                                    <i>üóëÔ∏è</i>
                                </button>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--slate); margin-top: 0.25rem;">
                                ${new Date(search.timestamp).toLocaleDateString()}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function loadSavedSearchItem(index) {
            const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
            if (index >= 0 && index < savedSearches.length) {
                document.getElementById('searchQuery').value = savedSearches[index].query;
                showNotification(`Loaded search: ${savedSearches[index].name}`, 'success');
                performSearch();
            }
        }

        function deleteSavedSearch(event, index) {
            event.stopPropagation();
            
            if (confirm('Delete this saved search?')) {
                const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
                savedSearches.splice(index, 1);
                localStorage.setItem('savedSearches', JSON.stringify(savedSearches));
                
                showNotification('Search deleted', 'success');
                updateSavedSearchesDisplay();
            }
        }

        function exportResults() {
            if (currentSearchResults.length === 0) {
                showNotification('No results to export', 'error');
                return;
            }
            
            try {
                // Create CSV content
                const headers = ['Title', 'Case Number', 'Judge', 'Type', 'Date', 'File', 'Size', 'Pages', 'OCR Processed'];
                const rows = currentSearchResults.map(result => [
                    result.title || result.filename,
                    result.case_number || '',
                    result.judge || '',
                    result.type || '',
                    result.date || '',
                    result.filename || '',
                    result.size || '',
                    result.pages || '',
                    result.ocr_processed ? 'Yes' : 'No'
                ]);
                
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');
                
                // Create download link
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `judicial_search_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showNotification(`Exported ${currentSearchResults.length} results to CSV`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Failed to export results', 'error');
            }
        }

        // Document action functions
        function viewDocument(id) {
            const result = currentSearchResults.find(r => r.id == id);
            if (result) {
                showNotification(`Opening document: ${result.title}`, 'info');
                
                // In a real app, this would open a document viewer
                // For now, show a modal with document info
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3>Document Viewer</h3>
                            <button class="btn btn-sm btn-outline" onclick="this.closest('.modal').remove()">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <h4 style="color: var(--navy); margin-bottom: var(--spacing-sm);">${escapeHtml(result.title)}</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-sm); margin-bottom: var(--spacing-md);">
                                <div><strong>Case:</strong> ${escapeHtml(result.case_number)}</div>
                                <div><strong>Judge:</strong> ${escapeHtml(result.judge)}</div>
                                <div><strong>Type:</strong> ${escapeHtml(result.type)}</div>
                                <div><strong>Date:</strong> ${escapeHtml(result.date)}</div>
                            </div>
                            <div style="background: var(--light-gray); padding: var(--spacing-md); border-radius: var(--border-radius);">
                                <p><strong>Document Preview:</strong></p>
                                <p style="font-style: italic;">"${escapeHtml(result.snippet)}"</p>
                            </div>
                            <p style="margin-top: var(--spacing-md);">This is a preview. In a real application, you would see the full document here.</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="downloadDocument('${id}')">Download</button>
                            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function downloadDocument(id) {
            const result = currentSearchResults.find(r => r.id == id);
            if (result) {
                showNotification(`Downloading: ${result.filename}`, 'success');
                
                // Simulate download
                setTimeout(() => {
                    showNotification(`${result.filename} downloaded successfully`, 'success');
                }, 1000);
            }
        }

        function showDocumentInfo(id) {
            const result = currentSearchResults.find(r => r.id == id);
            if (result) {
                const info = `
                    Document Details:
                    
                    Title: ${result.title}
                    Case Number: ${result.case_number}
                    Presiding Judge: ${result.judge}
                    Document Type: ${result.type}
                    Date: ${result.date}
                    File Name: ${result.filename}
                    File Size: ${result.size}
                    Pages: ${result.pages}
                    OCR Processed: ${result.ocr_processed ? 'Yes' : 'No'}
                    Relevance Score: ${Math.round(result.relevance * 100)}%
                    
                    Snippet:
                    "${result.snippet}"
                `;
                
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>Document Details</h3>
                            <button class="btn btn-sm btn-outline" onclick="this.closest('.modal').remove()">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <pre style="white-space: pre-wrap; font-family: var(--font-ui);">${escapeHtml(info)}</pre>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
        }

        function addToCase(id) {
            const result = currentSearchResults.find(r => r.id == id);
            if (result) {
                showNotification(`Adding "${result.title}" to case...`, 'info');
                
                // Simulate process
                setTimeout(() => {
                    showNotification(`Document added to case ${result.case_number}`, 'success');
                }, 500);
            }
        }

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', function() {
            // Set up form submission
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.addEventListener('submit', performSearch);
            }
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="dateTo"]').value = today;
            
            // Load saved searches display
            updateSavedSearchesDisplay();
            
            // Show welcome message
            showNotification('Legal Search ready. Try searching for "case", "fraud", or "Justice Katanu"', 'info');
        });
    </script>
</body>
</html>