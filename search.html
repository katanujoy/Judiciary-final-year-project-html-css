<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Search - Kenya Judiciary Digital Archives</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Merriweather:wght@300;400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .search-header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--dark-navy) 100%);
            color: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            margin-bottom: var(--spacing-lg);
        }
        
        .search-box {
            background: white;
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .search-advanced {
            background: white;
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-md);
            box-shadow: var(--shadow-sm);
        }
        
        .search-results {
            margin-top: var(--spacing-lg);
        }
        
        .result-card {
            background: white;
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            border-left: 4px solid var(--gold);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        
        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        
        .result-title {
            font-family: var(--font-heading);
            font-weight: 600;
            color: var(--navy);
            font-size: 1.1rem;
        }
        
        .result-snippet {
            color: var(--slate);
            margin: var(--spacing-sm) 0;
            line-height: 1.6;
        }
        
        .result-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            color: var(--slate);
            margin-top: var(--spacing-sm);
        }
        
        .result-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        .search-filters {
            background: white;
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .filter-section {
            margin-bottom: var(--spacing-lg);
        }
        
        .filter-title {
            font-weight: 600;
            color: var(--navy);
            margin-bottom: var(--spacing-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-tips {
            background: var(--light-gold);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }
        
        .highlight {
            background: var(--gold);
            color: var(--navy);
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body data-requires-auth="true">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h3>‚öñÔ∏è Kenya Judiciary</h3>
                <p>Digital Archives System</p>
            </div>
            <ul class="sidebar-nav">
                <li class="nav-item"><a href="dashboard.html"><i>üìä</i> Judicial Dashboard</a></li>
                <li class="nav-item"><a href="cases.html"><i>üìÅ</i> Case Registry</a></li>
                <li class="nav-item"><a href="upload.html"><i>üì§</i> File Upload</a></li>
                <li class="nav-item active"><a href="search.html"><i>üîç</i> Legal Search</a></li>
                <li class="nav-item"><a href="backup.html"><i>üíæ</i> System Backups</a></li>
                <li class="nav-item"><a href="users.html"><i>üë•</i> User Registry</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="search-header">
                <h1 style="color: white;">Legal Document Search</h1>
                <p style="color: rgba(255, 255, 255, 0.9);">
                    Search across all judicial documents, case files, and legal records
                </p>
            </header>

            <!-- Search Interface -->
            <div class="search-box">
                <form id="searchForm">
                    <div class="form-group">
                        <div style="display: flex; gap: var(--spacing-sm);">
                            <input type="search" 
                                   class="form-control" 
                                   id="searchQuery"
                                   placeholder="Enter case number, document title, legal terms, or content keywords..."
                                   style="flex: 1; font-size: 1.1rem; padding: 1rem;">
                            <button type="submit" class="btn btn-primary" id="searchBtn">
                                <span class="spinner" id="searchSpinner" style="display: none; margin-right: 8px;"></span>
                                <i>üîç</i> Search
                            </button>
                            <button type="button" class="btn btn-outline" onclick="toggleAdvanced()" id="toggleAdvanced">
                                <i>‚öôÔ∏è</i> Advanced
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Search Options -->
                    <div class="search-advanced" id="advancedOptions" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg);">
                            <div class="filter-section">
                                <div class="filter-title">Document Type</div>
                                <div style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="docType" value="ruling" checked> Court Rulings
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="docType" value="evidence" checked> Evidence Documents
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="docType" value="statement"> Witness Statements
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="docType" value="affidavit"> Affidavits
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="docType" value="pleading"> Pleadings
                                    </label>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-title">Case Information</div>
                                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                                    <div>
                                        <label class="form-label">Case Number</label>
                                        <input type="text" class="form-control" name="caseNumber" placeholder="e.g., CR-2024-001">
                                    </div>
                                    <div>
                                        <label class="form-label">Presiding Judge</label>
                                        <select class="form-control form-select" name="judge">
                                            <option value="">Any Judge</option>
                                            <option>Justice Katanu</option>
                                            <option>Justice Mwangi</option>
                                            <option>Justice Omondi</option>
                                            <option>Justice Wambua</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-title">Date Range</div>
                                <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
                                    <div>
                                        <label class="form-label">From Date</label>
                                        <input type="date" class="form-control" name="dateFrom">
                                    </div>
                                    <div>
                                        <label class="form-label">To Date</label>
                                        <input type="date" class="form-control" name="dateTo">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="filter-section">
                                <div class="filter-title">Search Options</div>
                                <div style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="searchOption" value="ocr" checked> Include OCR Text
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="searchOption" value="metadata" checked> Include Metadata
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="searchOption" value="exact"> Exact Phrase Match
                                    </label>
                                    <label class="d-flex align-center gap-2">
                                        <input type="checkbox" name="searchOption" value="fuzzy"> Fuzzy Search
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: var(--spacing-md); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <button type="button" class="btn btn-outline" onclick="saveSearch()">
                                    <i>üíæ</i> Save Search
                                </button>
                                <button type="button" class="btn btn-outline" onclick="loadSavedSearch()">
                                    <i>üìÇ</i> Load Saved
                                </button>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="performAdvancedSearch()">
                                <i>üîç</i> Advanced Search
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Search Results -->
            <div class="search-results" id="searchResults">
                <!-- Results will be loaded here -->
            </div>

            <!-- Search Tips -->
            <div class="search-tips">
                <h3 style="color: var(--navy); margin-bottom: var(--spacing-sm);">Search Tips</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-lg);">
                    <div>
                        <h4 style="color: var(--navy); font-size: 1rem; margin-bottom: 0.5rem;">Quick Search Examples</h4>
                        <ul style="color: var(--slate); line-height: 1.8; font-size: 0.9rem;">
                            <li><code>"land dispute" AND Nakuru</code> - Exact phrase with location</li>
                            <li><code>fraud OR embezzlement</code> - Either term</li>
                            <li><code>CR-2024-001</code> - Specific case number</li>
                            <li><code>Justice Katanu AND criminal</code> - Judge and case type</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 style="color: var(--navy); font-size: 1rem; margin-bottom: 0.5rem;">Legal Operators</h4>
                        <ul style="color: var(--slate); line-height: 1.8; font-size: 0.9rem;">
                            <li><strong>AND</strong> - Both terms must appear</li>
                            <li><strong>OR</strong> - Either term can appear</li>
                            <li><strong>NOT</strong> - Exclude term from results</li>
                            <li><strong>" "</strong> - Exact phrase match</li>
                            <li><strong>*</strong> - Wildcard (e.g., <code>judg*</code> finds judge, judgment, etc.)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Saved Searches -->
            <div class="card" style="margin-top: var(--spacing-xl);">
                <div class="card-header">
                    <h3>Saved Searches</h3>
                </div>
                <div class="card-body">
                    <div id="savedSearches">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-sm);">
                            <div class="saved-search" onclick="loadSearch('recent_cases')" style="cursor: pointer;">
                                <div style="font-weight: 600; color: var(--navy);">Recent Criminal Cases</div>
                                <div style="font-size: 0.9rem; color: var(--slate);">case_type:criminal AND date:2024</div>
                            </div>
                            <div class="saved-search" onclick="loadSearch('land_disputes')" style="cursor: pointer;">
                                <div style="font-weight: 600; color: var(--navy);">Land Disputes 2024</div>
                                <div style="font-size: 0.9rem; color: var(--slate);">"land dispute" AND court:Nakuru</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        // Search functionality
        let currentSearchResults = [];
        
        async function performSearch(event) {
            if (event) event.preventDefault();
            
            if (!requireAuth()) return;
            
            const query = document.getElementById('searchQuery').value.trim();
            const searchBtn = document.getElementById('searchBtn');
            const spinner = document.getElementById('searchSpinner');
            
            if (!query) {
                showNotification('Please enter search terms', 'error');
                return;
            }
            
            // Show loading state
            searchBtn.disabled = true;
            spinner.style.display = 'inline-block';
            
            try {
                // Prepare search parameters
                const params = new URLSearchParams();
                params.append('q', query);
                
                // Add advanced filters if visible
                if (document.getElementById('advancedOptions').style.display !== 'none') {
                    const formData = new FormData(document.getElementById('searchForm'));
                    for (const [key, value] of formData.entries()) {
                        params.append(key, value);
                    }
                }
                
                // Perform search
                const response = await fetch(`${API_ENDPOINTS.search}?${params.toString()}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const results = await response.json();
                    currentSearchResults = results;
                    displaySearchResults(results);
                } else {
                    throw new Error('Search failed');
                }
                
            } catch (error) {
                console.error('Search error:', error);
                showNotification('Search failed. Please try again.', 'error');
                // Fallback to mock data for demonstration
                displayMockResults();
            } finally {
                searchBtn.disabled = false;
                spinner.style.display = 'none';
            }
        }
        
        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (!results || results.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--slate);">
                        <i style="font-size: 3rem; opacity: 0.5; margin-bottom: 1rem;">üîç</i>
                        <h3>No Results Found</h3>
                        <p>Try different search terms or adjust your filters.</p>
                    </div>
                `;
                return;
            }
            
            resultsContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                    <h3>Search Results (${results.length} documents found)</h3>
                    <div>
                        <button class="btn btn-outline btn-sm" onclick="exportResults()">
                            <i>üì•</i> Export Results
                        </button>
                    </div>
                </div>
                ${results.map((result, index) => createResultCard(result, index)).join('')}
            `;
        }
        
        function createResultCard(result, index) {
            return `
                <div class="result-card" id="result-${index}">
                    <div class="result-header">
                        <div>
                            <div class="result-title">
                                <a href="#" onclick="viewDocument('${result.id}')" style="color: var(--navy); text-decoration: none;">
                                    ${escapeHtml(result.title || result.filename)}
                                </a>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--slate); margin-top: 0.25rem;">
                                ${escapeHtml(result.case_number || '')}
                                ${result.case_number && result.judge ? ' ‚Ä¢ ' : ''}
                                ${escapeHtml(result.judge || '')}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="badge badge-${result.type === 'Court Ruling' ? 'info' : result.type === 'Evidence' ? 'warning' : 'success'}">
                                ${escapeHtml(result.type || 'Document')}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--slate); margin-top: 0.25rem;">
                                ${escapeHtml(result.date || '')}
                            </div>
                        </div>
                    </div>
                    
                    ${result.snippet ? `
                    <div class="result-snippet">
                        ...${highlightSearchTerms(result.snippet)}...
                    </div>
                    ` : ''}
                    
                    <div class="result-meta">
                        <div><strong>File:</strong> ${escapeHtml(result.filename)}</div>
                        <div><strong>Size:</strong> ${escapeHtml(result.size || 'N/A')}</div>
                        <div><strong>Pages:</strong> ${escapeHtml(result.pages || 'N/A')}</div>
                        <div><strong>OCR:</strong> ${result.ocr_processed ? 'Yes' : 'No'}</div>
                    </div>
                    
                    <div class="result-actions">
                        <button class="btn btn-sm btn-outline" onclick="viewDocument('${result.id}')">
                            <i>üëÅÔ∏è</i> View Document
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="downloadDocument('${result.id}')">
                            <i>üì•</i> Download
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="showDocumentInfo('${result.id}')">
                            <i>‚ÑπÔ∏è</i> Details
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="addToCase('${result.id}')">
                            <i>üìÅ</i> Add to Case
                        </button>
                        <div style="margin-left: auto;">
                            <span style="font-size: 0.8rem; color: var(--gold); font-weight: 600;">
                                ${result.relevance ? `${Math.round(result.relevance * 100)}% match` : ''}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function highlightSearchTerms(text) {
            const query = document.getElementById('searchQuery').value.toLowerCase();
            if (!query) return escapeHtml(text);
            
            const words = query.split(' ').filter(word => word.length > 2);
            let highlighted = escapeHtml(text);
            
            words.forEach(word => {
                const regex = new RegExp(`(${word})`, 'gi');
                highlighted = highlighted.replace(regex, '<span class="highlight">$1</span>');
            });
            
            return highlighted;
        }
        
        function displayMockResults() {
            const mockResults = [
                {
                    id: 1,
                    title: 'Court Ruling on Criminal Case CR-2024-001',
                    filename: 'court_ruling_cr_2024_001.pdf',
                    case_number: 'CR-2024-001',
                    judge: 'Justice Katanu',
                    type: 'Court Ruling',
                    date: '2024-10-15',
                    size: '2.1 MB',
                    pages: '24',
                    ocr_processed: true,
                    snippet: 'The court finds the evidence presented compelling and rules in favor of the prosecution in the matter of financial fraud allegations.',
                    relevance: 0.95
                },
                {
                    id: 2,
                    title: 'Witness Statement - John Smith',
                    filename: 'witness_statement_john_smith.pdf',
                    case_number: 'CR-2024-001',
                    judge: 'Justice Katanu',
                    type: 'Witness Statement',
                    date: '2024-10-14',
                    size: '1.8 MB',
                    pages: '8',
                    ocr_processed: true,
                    snippet: 'I witnessed the incident on October 1st and can confirm the events as described in the police report regarding the land dispute.',
                    relevance: 0.87
                },
                {
                    id: 3,
                    title: 'Photographic Evidence - Scene Documentation',
                    filename: 'evidence_photo_1.jpg',
                    case_number: 'CR-2024-001',
                    judge: 'Justice Katanu',
                    type: 'Evidence',
                    date: '2024-10-13',
                    size: '4.2 MB',
                    pages: '1',
                    ocr_processed: false,
                    snippet: 'Photographic evidence showing the scene of the incident with clear markings of the disputed property boundaries.',
                    relevance: 0.76
                }
            ];
            
            displaySearchResults(mockResults);
        }
        
        function toggleAdvanced() {
            const advanced = document.getElementById('advancedOptions');
            const toggleBtn = document.getElementById('toggleAdvanced');
            
            if (advanced.style.display === 'none') {
                advanced.style.display = 'block';
                toggleBtn.innerHTML = '<i>‚¨ÜÔ∏è</i> Simple';
            } else {
                advanced.style.display = 'none';
                toggleBtn.innerHTML = '<i>‚öôÔ∏è</i> Advanced';
            }
        }
        
        function performAdvancedSearch() {
            performSearch();
        }
        
        function saveSearch() {
            const query = document.getElementById('searchQuery').value;
            if (!query) {
                showNotification('Please enter a search query first', 'error');
                return;
            }
            
            const name = prompt('Name for this saved search:');
            if (name) {
                // Save to localStorage
                const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
                savedSearches.push({
                    name: name,
                    query: query,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('savedSearches', JSON.stringify(savedSearches));
                
                showNotification(`Search saved as "${name}"`, 'success');
            }
        }
        
        function loadSavedSearch() {
            const savedSearches = JSON.parse(localStorage.getItem('savedSearches') || '[]');
            if (savedSearches.length === 0) {
                showNotification('No saved searches found', 'info');
                return;
            }
            
            // Show list of saved searches
            const searchList = savedSearches.map((search, index) => 
                `${index + 1}. ${search.name}: "${search.query}"`
            ).join('\n');
            
            const choice = prompt(`Saved searches:\n\n${searchList}\n\nEnter number to load:`);
            const index = parseInt(choice) - 1;
            
            if (index >= 0 && index < savedSearches.length) {
                document.getElementById('searchQuery').value = savedSearches[index].query;
                showNotification(`Loaded search: ${savedSearches[index].name}`, 'success');
            }
        }
        
        function loadSearch(name) {
            // Mock function for loading predefined searches
            switch(name) {
                case 'recent_cases':
                    document.getElementById('searchQuery').value = 'case_type:criminal AND date:2024';
                    break;
                case 'land_disputes':
                    document.getElementById('searchQuery').value = '"land dispute" AND court:Nakuru';
                    break;
            }
            showNotification(`Loaded search: ${name}`, 'success');
        }
        
        function exportResults() {
            if (currentSearchResults.length === 0) {
                showNotification('No results to export', 'error');
                return;
            }
            
            // Create CSV content
            const headers = ['Title', 'Case Number', 'Judge', 'Type', 'Date', 'File', 'Size'];
            const rows = currentSearchResults.map(result => [
                result.title || result.filename,
                result.case_number || '',
                result.judge || '',
                result.type || '',
                result.date || '',
                result.filename || '',
                result.size || ''
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `search_results_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`Exported ${currentSearchResults.length} results`, 'success');
        }
        
        function viewDocument(id) {
            showNotification(`Viewing document ${id}...`, 'info');
            // Implement document viewing
        }
        
        function downloadDocument(id) {
            showNotification(`Downloading document ${id}...`, 'success');
            // Implement document download
        }
        
        function showDocumentInfo(id) {
            const result = currentSearchResults.find(r => r.id === id);
            if (result) {
                const info = `
                    Document Details:
                    - Title: ${result.title}
                    - Case: ${result.case_number}
                    - Judge: ${result.judge}
                    - Type: ${result.type}
                    - Date: ${result.date}
                    - File: ${result.filename}
                    - Size: ${result.size}
                    - Pages: ${result.pages}
                    - OCR: ${result.ocr_processed ? 'Processed' : 'Not processed'}
                `;
                alert(info);
            }
        }
        
        function addToCase(id) {
            showNotification(`Adding document ${id} to case...`, 'info');
            // Implement add to case functionality
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.addEventListener('submit', performSearch);
            }
        });
    </script>
</body>
</html>